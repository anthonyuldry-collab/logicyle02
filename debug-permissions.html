<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Debug Permissions - LogiCycle</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            max-width: 800px;
            margin: 0 auto;
            padding: 20px;
            background-color: #f5f5f5;
        }
        .debug-section {
            background: white;
            padding: 20px;
            margin: 20px 0;
            border-radius: 8px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }
        .permission-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 10px;
            margin: 5px 0;
            background: #f8f9fa;
            border-radius: 4px;
        }
        .permission-granted {
            background: #d4edda;
            color: #155724;
        }
        .permission-denied {
            background: #f8d7da;
            color: #721c24;
        }
        .btn {
            background: #007bff;
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 4px;
            cursor: pointer;
            margin: 5px;
        }
        .btn:hover {
            background: #0056b3;
        }
        .btn-warning {
            background: #ffc107;
            color: #212529;
        }
        .btn-warning:hover {
            background: #e0a800;
        }
    </style>
</head>
<body>
    <h1>üîß Debug Permissions - LogiCycle</h1>
    
    <div class="debug-section">
        <h2>üìã Informations Utilisateur</h2>
        <p><strong>Email:</strong> <span id="userEmail">Non connect√©</span></p>
        <p><strong>R√¥le Utilisateur:</strong> <span id="userRole">Non d√©fini</span></p>
        <p><strong>R√¥le Permission:</strong> <span id="permissionRole">Non d√©fini</span></p>
        <p><strong>Nom:</strong> <span id="userName">Non d√©fini</span></p>
    </div>

    <div class="debug-section">
        <h2>üéØ Test des Permissions</h2>
        <p>Cliquez sur le bouton ci-dessous pour tester vos permissions actuelles :</p>
        <button class="btn" onclick="testPermissions()">Tester les Permissions</button>
        <button class="btn btn-warning" onclick="forceManagerRole()">Forcer le R√¥le Manager</button>
    </div>

    <div class="debug-section">
        <h2>üìä R√©sultats des Permissions</h2>
        <div id="permissionsResults">
            <p>Aucun test effectu√©. Cliquez sur "Tester les Permissions" pour commencer.</p>
        </div>
    </div>

    <div class="debug-section">
        <h2>üîç Logs de D√©bogage</h2>
        <div id="debugLogs" style="background: #f8f9fa; padding: 10px; border-radius: 4px; max-height: 300px; overflow-y: auto;">
            <p>Les logs de d√©bogage appara√Ætront ici...</p>
        </div>
    </div>

    <script>
        // Simulation des types et constantes
        const UserRole = {
            COUREUR: 'COUREUR',
            STAFF: 'STAFF',
            MANAGER: 'MANAGER'
        };

        const TeamRole = {
            VIEWER: 'VIEWER',
            MEMBER: 'MEMBER',
            EDITOR: 'EDITOR',
            ADMIN: 'ADMIN'
        };

        const AppSection = {
            DASHBOARD: 'dashboard',
            EVENTS: 'events',
            FINANCIAL: 'financial',
            PERFORMANCE: 'performance',
            STAFF: 'staff',
            ROSTER: 'roster',
            VEHICLES: 'vehicles',
            EQUIPMENT: 'equipment',
            SCOUTING: 'scouting',
            USER_MANAGEMENT: 'userManagement',
            PERMISSIONS: 'permissions'
        };

        // Fonction pour ajouter des logs
        function addLog(message) {
            const logsDiv = document.getElementById('debugLogs');
            const timestamp = new Date().toLocaleTimeString();
            logsDiv.innerHTML += `<p>[${timestamp}] ${message}</p>`;
            logsDiv.scrollTop = logsDiv.scrollHeight;
        }

        // Fonction pour simuler la r√©cup√©ration des permissions
        function getEffectivePermissions(user, basePermissions = {}, staff = []) {
            addLog(`üîç DEBUG - Utilisateur: ${JSON.stringify(user)}`);
            
            // V√©rifier si l'utilisateur est admin (via permissionRole) OU manager (via userRole)
            if (user.permissionRole === TeamRole.ADMIN || user.userRole === UserRole.MANAGER) {
                addLog('üéØ DEBUG - Utilisateur identifi√© comme Admin/Manager');
                
                const allPermissions = {};
                Object.values(AppSection).forEach(section => {
                    // Exclure les sections "Mon Espace"
                    const isMySpaceSection = [
                        'career', 'nutrition', 'riderEquipment', 'adminDossier', 
                        'myTrips', 'myPerformance', 'performanceProject', 'automatedPerformanceProfile'
                    ].includes(section);
                    
                    if (!isMySpaceSection) {
                        allPermissions[section] = ['view', 'edit'];
                        addLog(`‚úÖ DEBUG - Section ajout√©e: ${section}`);
                    }
                });
                
                addLog(`üéØ DEBUG - Permissions finales Admin/Manager: ${JSON.stringify(allPermissions)}`);
                return allPermissions;
            }
            
            addLog('‚ö†Ô∏è DEBUG - Utilisateur NOT Admin/Manager, utilisation des permissions par d√©faut');
            return {};
        }

        // Fonction pour tester les permissions
        function testPermissions() {
            addLog('üß™ D√©but du test des permissions...');
            
            // Simuler un utilisateur (vous devrez remplacer ces valeurs par les v√¥tres)
            const testUser = {
                email: document.getElementById('userEmail').textContent,
                userRole: document.getElementById('userRole').textContent,
                permissionRole: document.getElementById('permissionRole').textContent,
                firstName: document.getElementById('userName').textContent.split(' ')[0] || 'Test',
                lastName: document.getElementById('userName').textContent.split(' ')[1] || 'User'
            };
            
            if (testUser.email === 'Non connect√©') {
                addLog('‚ùå ERREUR: Aucun utilisateur connect√©. Connectez-vous d\'abord √† l\'application.');
                return;
            }
            
            const permissions = getEffectivePermissions(testUser);
            
            // Afficher les r√©sultats
            const resultsDiv = document.getElementById('permissionsResults');
            let html = '<h3>R√©sultats du Test :</h3>';
            
            if (Object.keys(permissions).length === 0) {
                html += '<p class="permission-denied">‚ùå Aucune permission accord√©e</p>';
            } else {
                Object.entries(permissions).forEach(([section, levels]) => {
                    const isGranted = levels.includes('view') || levels.includes('edit');
                    const className = isGranted ? 'permission-granted' : 'permission-denied';
                    const icon = isGranted ? '‚úÖ' : '‚ùå';
                    html += `<div class="permission-item ${className}">
                        <span>${icon} ${section}</span>
                        <span>${levels.join(', ')}</span>
                    </div>`;
                });
            }
            
            resultsDiv.innerHTML = html;
            addLog('‚úÖ Test des permissions termin√©');
        }

        // Fonction pour forcer le r√¥le Manager
        function forceManagerRole() {
            addLog('üîß Tentative de for√ßage du r√¥le Manager...');
            addLog('‚ö†Ô∏è ATTENTION: Cette fonction est en mode simulation uniquement');
            addLog('üí° Pour vraiment changer votre r√¥le, vous devez :');
            addLog('   1. Vous connecter √† l\'application principale');
            addLog('   2. Utiliser le bouton "Forcer le r√¥le Manager" dans l\'interface');
            addLog('   3. Ou contacter un administrateur');
            
            // Simuler le changement
            document.getElementById('userRole').textContent = 'MANAGER';
            document.getElementById('permissionRole').textContent = 'ADMIN';
            
            addLog('‚úÖ R√¥le simul√© chang√© en Manager/Admin');
            addLog('üîÑ Rechargez la page pour voir les changements');
        }

        // Initialisation
        addLog('üöÄ Page de d√©bogage charg√©e');
        addLog('üí° Utilisez cette page pour diagnostiquer vos probl√®mes de permissions');
        addLog('üîß Vous pouvez aussi utiliser le bouton "Forcer le R√¥le Manager" pour tester');
    </script>
</body>
</html>
